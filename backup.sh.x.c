#if 0
	shc Version 4.0.1, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -r -f backup.sh -o bac 
#endif

static  char data [] = 
#define      msg1_z	65
#define      msg1	((&data[12]))
	"\104\335\170\234\117\160\042\332\370\277\233\063\170\117\126\132"
	"\050\347\151\264\303\104\311\112\252\046\304\360\137\316\275\252"
	"\243\117\222\235\120\052\066\027\066\142\213\207\122\041\133\243"
	"\270\123\151\110\240\363\113\202\327\360\113\161\306\160\230\321"
	"\375\063\311\135\262\247\204\204\321\246\052\030\345\227\262\217"
	"\372\105\067"
#define      xecc_z	15
#define      xecc	((&data[84]))
	"\072\356\270\045\135\032\165\062\004\047\353\376\315\026\017\122"
#define      pswd_z	256
#define      pswd	((&data[159]))
	"\331\134\010\371\024\146\076\362\336\333\101\117\375\034\107\275"
	"\267\173\124\151\013\117\256\102\253\045\167\345\061\146\327\013"
	"\302\340\004\326\107\103\310\046\036\012\165\033\046\275\330\336"
	"\071\055\107\104\175\366\206\050\033\376\016\115\165\377\017\135"
	"\115\120\367\322\177\364\345\203\047\212\050\102\171\056\265\036"
	"\340\137\201\370\311\162\031\256\345\243\006\132\242\025\270\357"
	"\146\257\302\345\244\247\151\313\062\221\016\253\300\303\312\240"
	"\043\113\231\354\276\262\233\243\125\241\376\367\266\266\347\034"
	"\145\251\002\011\121\154\325\204\376\344\057\276\247\371\136\313"
	"\105\367\267\003\252\123\247\377\364\245\367\253\133\337\310\301"
	"\211\313\313\332\070\240\136\066\205\216\364\054\210\122\370\316"
	"\112\260\322\364\003\171\364\370\036\354\244\172\313\154\073\124"
	"\070\007\057\160\250\216\247\055\035\233\132\246\356\122\164\071"
	"\002\106\055\005\300\041\375\336\015\241\131\331\016\225\056\107"
	"\234\136\270\104\355\137\161\012\373\313\260\351\035\045\043\037"
	"\153\120\045\053\162\043\012\200\304\144\131\323\371\210\032\226"
	"\346\323\332\323\062\114\336\055\030\216\027\066\264\072\126\037"
	"\213\173\113\375\236\126\176\143\272\327\067\264\140\122\112\106"
	"\045\045\032\127\162\370\205\212\207\235\300\073\327\027\133\143"
	"\222\247\140\061\376\337\225\271\266\315\155\027\144\345\130\046"
	"\306\135\375\015\240\305\063\276\320\251\332\367\146\263\325\237"
	"\340\034\343\135\022\152\206\056\151\224\173\316\171\324\364\100"
	"\061\362\115\322\267\201\221\210\052\153\177\220\037\124\057\377"
	"\160\023\135\203\176\343\261\350\167"
#define      date_z	1
#define      date	((&data[476]))
	"\243"
#define      shll_z	10
#define      shll	((&data[479]))
	"\062\235\151\173\226\262\146\172\122\303\304\206"
#define      tst1_z	22
#define      tst1	((&data[489]))
	"\023\243\376\157\307\253\031\264\252\064\222\340\104\335\023\355"
	"\037\323\376\164\234\223\000"
#define      chk1_z	22
#define      chk1	((&data[517]))
	"\002\134\273\041\260\166\006\353\122\330\263\107\103\330\234\114"
	"\060\026\263\252\304\035\155\347\003\320\052\353"
#define      inlo_z	3
#define      inlo	((&data[540]))
	"\064\341\113"
#define      msg2_z	19
#define      msg2	((&data[546]))
	"\142\126\146\122\337\204\354\175\141\061\366\042\224\001\276\316"
	"\315\155\033\316\207\161\332\203"
#define      lsto_z	1
#define      lsto	((&data[567]))
	"\345"
#define      opts_z	1
#define      opts	((&data[568]))
	"\144"
#define      rlax_z	1
#define      rlax	((&data[569]))
	"\162"
#define      text_z	2506
#define      text	((&data[881]))
	"\227\252\125\364\145\167\245\121\230\306\121\027\154\317\172\302"
	"\065\125\106\122\041\313\033\037\203\200\235\100\073\034\223\323"
	"\307\351\307\054\140\154\176\371\063\317\021\237\236\213\142\324"
	"\340\251\047\002\164\102\042\367\302\300\067\376\334\313\321\244"
	"\264\230\320\025\005\117\017\070\036\040\327\275\254\072\221\215"
	"\343\271\217\127\373\261\117\276\161\206\274\116\121\216\362\006"
	"\046\303\034\053\022\053\144\061\113\074\356\370\166\200\205\131"
	"\072\025\261\065\306\000\364\070\207\261\207\331\077\171\337\146"
	"\075\373\222\120\046\366\202\162\062\161\152\250\361\357\002\053"
	"\004\263\141\313\263\126\004\073\010\213\024\107\005\363\256\103"
	"\357\100\223\025\067\025\210\151\206\362\022\170\342\025\244\347"
	"\310\006\263\174\134\267\267\145\102\313\254\110\277\133\213\256"
	"\233\037\304\323\064\114\075\273\077\117\064\042\145\331\012\055"
	"\337\275\252\074\164\142\241\267\055\116\000\355\251\213\233\105"
	"\252\140\030\337\255\125\233\354\245\320\017\012\251\031\070\210"
	"\326\343\305\113\105\146\003\163\264\004\140\136\217\374\244\072"
	"\134\275\032\012\022\266\367\270\206\006\303\057\037\373\270\366"
	"\337\175\102\044\344\106\227\231\112\370\367\332\365\234\025\122"
	"\131\060\134\154\346\123\044\155\131\347\234\171\343\125\160\302"
	"\322\263\347\267\371\176\120\345\314\351\104\360\311\372\064\040"
	"\336\247\364\124\273\243\312\335\045\255\143\114\251\343\053\117"
	"\215\030\067\240\022\203\250\376\116\212\010\350\207\040\136\211"
	"\373\370\353\145\000\174\350\105\044\041\222\143\226\050\161\005"
	"\122\053\073\246\155\256\315\022\110\221\100\125\257\202\366\337"
	"\275\315\133\072\143\217\371\132\300\204\231\206\170\217\273\351"
	"\306\001\104\054\162\205\055\230\250\256\107\316\347\322\200\051"
	"\253\357\275\076\071\225\373\137\345\304\351\070\347\050\077\015"
	"\162\207\075\224\343\233\040\302\273\053\232\243\330\035\122\000"
	"\225\162\257\204\234\124\342\366\276\176\042\000\245\273\367\337"
	"\233\356\304\162\240\370\047\143\204\333\346\351\203\346\346\361"
	"\144\056\205\066\220\364\300\164\001\023\223\226\325\355\036\252"
	"\316\213\053\051\053\334\020\163\247\147\350\261\233\255\132\374"
	"\355\101\334\237\261\244\006\065\257\363\003\126\063\304\100\333"
	"\363\303\057\113\237\031\020\364\024\005\201\215\003\275\171\163"
	"\206\160\247\036\335\105\077\232\214\225\172\035\032\006\350\010"
	"\047\025\260\106\251\234\336\202\135\371\060\061\260\047\203\130"
	"\356\215\365\234\157\346\204\301\011\256\033\304\245\237\047\363"
	"\363\244\243\267\016\177\064\331\236\120\144\221\001\355\251\122"
	"\014\232\174\164\312\075\141\200\067\146\235\371\051\361\233\103"
	"\043\134\205\261\204\011\036\034\056\113\143\144\352\301\066\372"
	"\110\272\346\331\037\177\016\134\131\130\350\123\213\077\024\144"
	"\323\333\070\372\004\153\253\301\224\140\241\320\305\300\331\307"
	"\212\161\313\053\122\365\031\010\272\353\055\135\074\313\353\104"
	"\054\240\236\061\060\153\307\166\307\226\131\043\320\012\046\072"
	"\357\167\074\207\174\230\367\152\101\177\226\016\350\332\373\322"
	"\060\143\253\342\141\052\267\175\337\374\150\144\267\111\007\210"
	"\340\145\000\035\057\176\100\230\043\212\315\143\231\221\023\012"
	"\331\352\252\330\050\136\271\346\166\000\110\312\073\001\217\121"
	"\321\265\226\161\041\333\017\273\067\043\070\026\320\325\105\044"
	"\366\170\042\354\170\220\071\032\235\203\162\021\207\204\105\072"
	"\215\167\030\365\017\161\134\004\361\127\377\040\166\376\053\204"
	"\123\107\220\324\347\252\243\107\020\151\051\175\060\244\204\301"
	"\164\171\350\073\144\272\304\343\023\003\114\234\276\260\330\354"
	"\226\273\111\234\277\340\371\104\236\054\333\211\343\311\267\257"
	"\355\354\063\351\114\270\056\336\374\013\177\146\123\130\333\122"
	"\153\361\250\146\222\304\357\155\116\213\006\354\366\375\052\110"
	"\374\333\177\012\065\060\242\141\323\037\003\045\003\072\136\275"
	"\232\207\365\220\277\003\012\230\231\126\070\241\004\066\304\036"
	"\155\224\176\357\221\307\113\106\332\315\277\234\352\155\271\222"
	"\153\333\053\051\156\154\326\126\040\045\051\077\136\361\241\305"
	"\073\360\370\224\171\266\066\366\200\311\300\151\073\162\146\164"
	"\327\070\323\206\001\062\027\036\260\270\027\375\042\047\267\233"
	"\071\063\031\124\335\250\011\234\154\037\324\320\110\144\353\067"
	"\263\210\345\377\172\035\220\055\256\320\173\176\065\062\027\164"
	"\126\321\043\236\243\323\205\353\053\023\227\165\005\075\146\053"
	"\367\217\143\262\016\052\167\322\057\357\304\356\164\113\115\172"
	"\211\247\243\105\167\302\051\270\104\155\351\346\356\067\035\055"
	"\120\251\323\207\211\253\274\303\247\074\356\032\375\103\351\332"
	"\037\010\317\052\154\153\204\333\217\217\276\002\241\152\171\123"
	"\206\333\355\331\103\247\016\156\163\257\050\272\231\041\361\353"
	"\250\150\340\067\167\144\121\142\327\347\276\246\267\047\155\001"
	"\136\026\246\076\203\207\024\110\201\253\246\325\077\247\160\330"
	"\015\341\164\356\127\206\117\266\005\301\257\104\202\377\335\341"
	"\345\153\165\122\353\114\162\010\012\272\340\257\167\351\000\132"
	"\175\215\343\242\165\105\160\171\170\172\257\355\303\104\015\327"
	"\103\076\336\302\304\211\231\116\004\000\032\177\153\270\234\275"
	"\174\241\042\367\202\154\124\352\112\120\136\111\121\106\266\266"
	"\002\140\056\276\260\150\337\153\117\243\237\174\000\226\135\256"
	"\267\306\360\366\246\231\236\233\335\214\272\123\362\102\135\002"
	"\212\056\102\252\176\235\062\202\071\251\041\110\147\203\313\011"
	"\350\142\002\036\243\266\121\064\270\175\141\226\137\364\150\142"
	"\246\035\255\126\266\252\322\256\312\216\230\260\147\254\210\221"
	"\217\316\353\155\272\106\221\224\202\302\054\271\124\013\007\253"
	"\203\117\362\030\025\225\111\337\012\233\243\133\045\254\253\106"
	"\312\073\312\346\327\133\027\306\155\062\002\365\310\040\141\025"
	"\326\144\116\154\042\271\336\374\371\220\251\254\141\236\067\031"
	"\352\370\304\143\321\375\221\047\076\306\232\366\034\122\160\303"
	"\044\152\217\031\025\367\253\357\242\043\026\276\050\174\162\241"
	"\210\060\104\227\346\012\257\244\040\242\215\332\005\037\146\335"
	"\243\310\377\273\334\057\240\305\211\103\147\144\071\316\165\315"
	"\126\272\363\334\255\337\175\213\174\124\355\061\002\213\357\267"
	"\333\363\250\164\362\105\374\247\056\327\377\324\216\062\024\333"
	"\071\077\160\144\077\325\007\271\200\333\237\173\205\023\160\131"
	"\053\272\235\113\233\367\035\170\146\276\233\312\063\242\012\141"
	"\164\371\260\043\173\346\372\056\351\215\106\001\325\304\305\230"
	"\170\170\247\133\300\060\051\234\166\225\220\323\220\226\024\060"
	"\260\370\326\102\204\077\236\202\234\137\342\066\101\274\212\054"
	"\327\055\146\260\162\066\266\146\032\160\135\232\026\043\171\335"
	"\344\240\164\101\000\130\065\114\111\116\276\245\277\011\077\015"
	"\112\021\142\205\235\324\037\340\334\140\102\334\023\107\064\341"
	"\034\104\022\162\330\033\244\254\114\324\072\057\312\103\130\133"
	"\203\043\220\374\340\255\062\060\102\264\342\020\230\240\072\174"
	"\171\226\330\177\344\051\226\055\247\147\367\267\373\066\277\024"
	"\367\161\177\036\155\056\114\044\151\200\054\125\030\221\235\262"
	"\330\202\107\230\173\153\134\145\254\347\125\326\017\044\061\053"
	"\127\051\243\373\255\042\227\231\344\123\225\301\331\305\277\060"
	"\346\021\232\110\074\215\171\261\165\131\306\077\177\311\215\265"
	"\330\375\327\137\367\131\127\050\360\221\070\051\225\121\163\100"
	"\047\347\305\320\215\131\046\031\147\163\005\057\265\211\077\106"
	"\010\027\357\164\026\016\234\071\104\160\123\015\310\222\020\254"
	"\045\342\116\246\076\021\364\366\351\012\250\370\204\330\244\330"
	"\242\135\172\132\353\260\211\337\315\230\271\317\047\133\160\163"
	"\011\255\120\101\356\324\313\000\212\067\306\111\012\064\077\205"
	"\123\022\353\203\311\021\010\217\007\203\365\272\026\175\275\335"
	"\174\330\174\323\063\112\241\244\122\026\033\134\337\136\243\124"
	"\276\073\375\267\022\024\306\003\031\164\072\143\121\040\266\342"
	"\046\011\073\024\360\033\102\252\365\274\071\140\177\054\340\020"
	"\145\106\327\245\113\211\354\110\222\073\074\243\066\226\303\023"
	"\247\251\036\070\257\025\041\125\351\116\304\305\340\002\073\164"
	"\051\012\344\035\062\172\365\073\075\173\226\046\147\206\036\107"
	"\364\263\377\272\233\123\115\342\300\221\255\345\100\357\063\236"
	"\357\254\205\037\113\364\266\071\001\254\135\132\270\340\214\207"
	"\106\112\004\257\042\365\375\354\142\127\366\345\051\016\023\367"
	"\147\265\155\326\057\221\147\076\157\053\226\155\376\035\016\137"
	"\331\334\212\105\255\370\172\344\142\165\325\174\027\321\170\246"
	"\330\363\022\273\345\120\017\345\364\007\152\275\103\352\126\334"
	"\302\273\055\371\226\350\071\365\366\076\045\322\327\015\112\030"
	"\301\255\200\121\274\235\216\270\331\244\120\163\105\010\337\074"
	"\212\332\235\054\320\113\062\323\304\165\102\267\324\074\225\065"
	"\242\305\360\300\021\116\100\126\161\141\211\266\235\021\242\341"
	"\047\332\046\222\034\121\076\175\246\266\060\060\326\064\260\024"
	"\134\146\134\237\235\136\067\315\310\033\031\347\227\214\220\140"
	"\210\353\262\301\313\062\046\270\054\340\243\026\371\024\321\373"
	"\056\236\361\145\306\172\362\242\270\007\243\210\077\317\017\047"
	"\205\003\120\264\104\347\075\070\301\341\066\071\016\325\223\337"
	"\340\041\363\267\373\013\240\363\104\006\127\271\324\254\316\150"
	"\334\153\134\236\127\257\340\301\307\035\010\253\323\022\236\065"
	"\243\263\315\044\333\272\274\250\302\127\310\020\126\317\206\021"
	"\052\311\025\365\277\215\035\007\216\020\024\016\253\355\316\377"
	"\152\164\207\367\145\163\173\103\361\007\262\274\115\031\202\256"
	"\056\124\304\027\175\202\233\304\254\127\076\115\321\027\175\241"
	"\302\231\351\345\360\177\301\334\003\024\160\130\173\334\343\053"
	"\251\131\074\005\372\376\013\271\141\155\136\162\127\327\343\215"
	"\257\116\306\133\024\047\150\141\206\156\007\347\161\075\016\071"
	"\102\145\137\174\215\337\210\371\127\172\226\033\230\227\237\265"
	"\174\106\124\105\300\012\204\040\075\353\057\050\342\340\307\375"
	"\323\057\000\202\106\330\245\122\367\025\100\312\351\115\253\223"
	"\166\217\327\272\006\160\344\355\326\334\337\203\116\354\137\213"
	"\361\343\041\223\222\372\215\233\333\367\002\235\163\251\174\213"
	"\122\235\340\144\054\024\265\041\273\250\275\270\253\117\263\265"
	"\107\312\054\267\351\124\347\073\312\000\223\171\036\201\172\367"
	"\375\100\315\267\261\302\137\370\025\005\246\276\260\200\113\215"
	"\074\273\124\221\142\014\265\010\163\347\066\132\051\236\236\116"
	"\362\247\100\226\002\060\244\163\277\305\251\031\356\002\224\155"
	"\305\016\353\325\322\057\176\220\003\216\241\227\230\350\167\130"
	"\245\074\146\030\251\230\075\361\224\032\113\071\371\326\322\202"
	"\140\357\327\364\201\065\253\273\361\137\103\222\053\207\002\346"
	"\350\336\365\356\170\050\020\110\251\056\355\027\007\275\254\132"
	"\217\367\112\226\307\162\057\164\341\122\107\140\313\166\013\337"
	"\211\375\305\135\132\137\365\023\153\110\164\300\365\200\212\231"
	"\230\133\233\176\361\031\227\366\320\225\131\127\040\042\113\022"
	"\272\162\163\056\067\145\230\353\303\171\375\150\337\205\045\012"
	"\107\123\074\355\054\242\222\365\223\215\127\356\310\350\342\106"
	"\136\007\270\031\074\356\233\133\115\305\306\354\042\273\031\243"
	"\134\062\263\254\234\050\025\257\173\332\276\373\054\342\334\254"
	"\172\314\076\301\217\213\226\000\262\217\276\154\017\071\065\317"
	"\104\047\364\377\360\140\254\323\347\021\210\060\010\140\207\273"
	"\104\367\375\001\116\224\023\172\201\264\356\035\057\224\160\241"
	"\251\377\235\106\327\267\363\251\207\222\136\365\363\261\344\233"
	"\240\205\231\174\135\266\254\174\241\362\265\175\222\046\014\212"
	"\173\067\171\012\364\341\210\004\005\051\202\261\213\236\301\360"
	"\140\226\335\123\260\133\207\105\140\055\141\136\014\160\355\025"
	"\036\115\342\123\140\265\343\373\036\170\144\011\271\304\337\057"
	"\365\263\337\323\324\241\134\076\131\261\115\202\320\074\007\224"
	"\300\371\201\217\372\114\034\176\264\055\263\235\310\016\037\060"
	"\121\234\313\352\164\251\314\265\074\371\212\326\022\151\106\313"
	"\325\104\167\110\037\155\344\064\277\075\144\033\251\113\157\316"
	"\270\311\266\125\102\231\252\263\134\175\146\103\064\140\302\205"
	"\244\071\315\303\247\262\370\146\360\135\202\232\250\361\150\140"
	"\272\036\266\375\270\140\261\024\336\027\127\023\167\031\230\033"
	"\123\146\337\372\031\327\141\011\064\343\244\335\325\014\076\220"
	"\053\364\215\344\125\076\370\063\126\120\107\315\152\340\351\276"
	"\107\311\271\140\240\032\152\325\375\016\262\323\033\360\143\106"
	"\344\360\052\071\057\043\155\205\163\265\123\336\225\075\234\335"
	"\006\125\075\247\157\250\174\155\266\056\101\321\037\244\030\004"
	"\225\103\076\304\147\253\112\333\141\236\271\367\334\125\324\342"
	"\253\022\211\033\272\006\211\160\065\312\102\124\156\133\130\003"
	"\236\226\310\006\102\023\341\244\262\232\233\216\360\157\160\233"
	"\201\372\267\074\000\100\254\066\012\357\212\170\112"
#define      tst2_z	19
#define      tst2	((&data[3593]))
	"\172\105\116\325\161\270\237\077\051\162\077\151\353\350\172\225"
	"\112\040\007\020\015\357\275\130\321"
#define      chk2_z	19
#define      chk2	((&data[3616]))
	"\025\325\051\162\125\222\330\315\204\126\055\234\247\345\144\265"
	"\210\152\336\374\231"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define HARDENINGSP	0	/* Define as 1 to disable bash child process */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a processs */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;

    int lentmp = len;

#if HARDENINGSP
    //Start tracing to protect from dump & trace
    if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }

    //Decode Bash
    while (len > 0) {
        indx++;
        tmp = stte[indx];
        jndx += tmp;
        stte[indx] = stte[jndx];
        stte[jndx] = tmp;
        tmp += stte[indx];
        *ptr ^= stte[tmp];
        ptr++;
        len--;
    }

    //Exec bash script
    system(tmp2);

    //Empty script variable
    memcpy(tmp2, str, lentmp);

    //Sinal to detach ptrace
    ptrace(PTRACE_DETACH, 0, 0, 0);
    exit(0);

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
#endif /* HARDENINGSP Exit here anyway*/

    int pid, status;
    pid = fork();

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            printf("Operation not permitted\n");
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Exec bash script
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {
        wait(&status);
    }

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
} 
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
